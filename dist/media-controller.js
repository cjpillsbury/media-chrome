import C from"./media-container.js";import{defineCustomElement as O}from"./utils/defineCustomElement.js";import{Window as E,Document as w}from"./utils/server-safe-globals.js";import{fullscreenApi as S}from"./utils/fullscreenApi.js";import{constToCamel as v}from"./utils/stringUtils.js";import{MediaUIEvents as h,MediaUIAttributes as r,TextTrackKinds as _,TextTrackModes as T}from"./constants.js";import{stringifyTextTrackList as l,getTextTracksList as I,updateTracksModeTo as M}from"./utils/captions.js";const{MEDIA_PLAY_REQUEST:y,MEDIA_PAUSE_REQUEST:Q,MEDIA_MUTE_REQUEST:x,MEDIA_UNMUTE_REQUEST:N,MEDIA_VOLUME_REQUEST:B,MEDIA_ENTER_FULLSCREEN_REQUEST:W,MEDIA_EXIT_FULLSCREEN_REQUEST:H,MEDIA_SEEK_REQUEST:j,MEDIA_PREVIEW_REQUEST:F,MEDIA_ENTER_PIP_REQUEST:G,MEDIA_EXIT_PIP_REQUEST:V,MEDIA_PLAYBACK_RATE_REQUEST:K}=h;class b extends C{constructor(){super();this.mediaStateReceivers=[],this.associatedElementSubscriptions=new Map,this.associatedElements=[],this.associateElement(this);const t={MEDIA_PLAY_REQUEST:()=>this.media.play(),MEDIA_PAUSE_REQUEST:()=>this.media.pause(),MEDIA_MUTE_REQUEST:()=>this.media.muted=!0,MEDIA_UNMUTE_REQUEST:()=>{const e=this.media;e.muted=!1,e.volume===0&&(e.volume=.25)},MEDIA_VOLUME_REQUEST:e=>{const i=this.media,s=e.detail;i.volume=s,s>0&&i.muted&&(i.muted=!1);try{E.localStorage.setItem("media-chrome-pref-volume",s.toString())}catch(n){}},MEDIA_ENTER_FULLSCREEN_REQUEST:()=>{const e=this.getRootNode(),i=this.media;e.pictureInPictureElement&&e.exitPictureInPicture(),super[S.enter]?super[S.enter]():i.webkitEnterFullscreen?i.webkitEnterFullscreen():i.requestFullscreen?i.requestFullscreen():console.warn("MediaChrome: Fullscreen not supported")},MEDIA_EXIT_FULLSCREEN_REQUEST:()=>{w[S.exit]()},MEDIA_ENTER_PIP_REQUEST:()=>{const e=this.getRootNode(),i=this.media;!e.pictureInPictureEnabled||(e[S.element]&&e[S.exit](),i.requestPictureInPicture())},MEDIA_EXIT_PIP_REQUEST:()=>{const e=this.getRootNode();e.exitPictureInPicture&&e.exitPictureInPicture()},MEDIA_SEEK_REQUEST:e=>{const i=this.media,s=e.detail;(i.readyState>0||i.readyState===void 0)&&(i.currentTime=s)},MEDIA_PLAYBACK_RATE_REQUEST:e=>{this.media.playbackRate=e.detail},MEDIA_PREVIEW_REQUEST:e=>{const i=this.media;if(!i)return;const[s]=I(i,{kind:_.METADATA,label:"thumbnails"});if(!(s&&s.cues))return;const n=e.detail,o=Array.prototype.find.call(s.cues,m=>m.startTime>=n);if(!o)return;const p=new URL(o.text),c=new URLSearchParams(p.hash).get("#xywh");this.propagateMediaState(r.MEDIA_PREVIEW_IMAGE,p.href),this.propagateMediaState(r.MEDIA_PREVIEW_COORDS,c.split(",").join(" "))},MEDIA_SHOW_CAPTIONS_REQUEST:e=>{const i=this.captionTracks,{detail:s=[]}=e;M(T.SHOWING,i,s)},MEDIA_DISABLE_CAPTIONS_REQUEST:e=>{const i=this.captionTracks,{detail:s=[]}=e;M(T.DISABLED,i,s)},MEDIA_SHOW_SUBTITLES_REQUEST:e=>{const i=this.subtitleTracks,{detail:s=[]}=e;M(T.SHOWING,i,s)},MEDIA_DISABLE_SUBTITLES_REQUEST:e=>{const i=this.subtitleTracks,{detail:s=[]}=e;M(T.DISABLED,i,s)},MEDIA_AIRPLAY_REQUEST:e=>{const{media:i}=this;if(!!i){if(!(i.webkitShowPlaybackTargetPicker&&E.WebKitPlaybackTargetAvailabilityEvent)){console.warn("received a request to select AirPlay but AirPlay is not supported in this environment");return}i.webkitShowPlaybackTargetPicker()}}};Object.keys(t).forEach(e=>{const i=`_handle${v(e,!0)}`;this[i]=s=>{if(s.stopPropagation(),!this.media){console.warn("MediaController: No media available.");return}t[e](s,this.media)},this.addEventListener(h[e],this[i])}),this._mediaStatePropagators={"play,pause":()=>{this.propagateMediaState(r.MEDIA_PAUSED,this.paused)},volumechange:()=>{this.propagateMediaState(r.MEDIA_MUTED,this.muted),this.propagateMediaState(r.MEDIA_VOLUME,this.volume),this.propagateMediaState(r.MEDIA_VOLUME_LEVEL,this.volumeLevel)},[S.event]:()=>{const e=this.getRootNode()[S.element];this.propagateMediaState(r.MEDIA_IS_FULLSCREEN,e===this)},"enterpictureinpicture,leavepictureinpicture":e=>{let i;e?i=e.type=="enterpictureinpicture":i=this.isPip,this.propagateMediaState(r.MEDIA_IS_PIP,i)},"timeupdate,loadedmetadata":()=>{this.propagateMediaState(r.MEDIA_CURRENT_TIME,this.currentTime)},"durationchange,loadedmetadata":()=>{this.propagateMediaState(r.MEDIA_DURATION,this.duration)},ratechange:()=>{this.propagateMediaState(r.MEDIA_PLAYBACK_RATE,this.playbackRate)},"waiting,playing":()=>{var i;const e=((i=this.media)==null?void 0:i.readyState)<3;this.propagateMediaState(r.MEDIA_LOADING,e)}},this._textTrackMediaStatePropagators={"addtrack,removetrack":()=>{this.propagateMediaState(r.MEDIA_CAPTIONS_LIST,l(this.captionTracks)||void 0),this.propagateMediaState(r.MEDIA_SUBTITLES_LIST,l(this.subtitleTracks)||void 0),this.propagateMediaState(r.MEDIA_CAPTIONS_SHOWING,l(this.showingCaptionTracks)||void 0),this.propagateMediaState(r.MEDIA_SUBTITLES_SHOWING,l(this.showingSubtitleTracks)||void 0)},change:()=>{this.propagateMediaState(r.MEDIA_CAPTIONS_SHOWING,l(this.showingCaptionTracks)||void 0),this.propagateMediaState(r.MEDIA_SUBTITLES_SHOWING,l(this.showingSubtitleTracks)||void 0)}}}mediaSetCallback(t){super.mediaSetCallback(t),Object.keys(this._mediaStatePropagators).forEach(e=>{const i=e.split(","),s=this._mediaStatePropagators[e];i.forEach(n=>{(n==S.event?this.getRootNode():t).addEventListener(n,s)}),s()}),Object.entries(this._textTrackMediaStatePropagators).forEach(([e,i])=>{e.split(",").forEach(n=>{t.textTracks&&t.textTracks.addEventListener(n,i)}),i()});try{const e=E.localStorage.getItem("media-chrome-pref-volume");e!==null&&(t.volume=e)}catch(e){console.debug("Error getting volume pref",e)}}mediaUnsetCallback(t){super.mediaUnsetCallback(t),Object.keys(this._mediaStatePropagators).forEach(e=>{const i=e.split(","),s=this._mediaStatePropagators[e];i.forEach(n=>{(n==S.event?this.getRootNode():t).removeEventListener(n,s)})}),Object.entries(this._textTrackMediaStatePropagators).forEach(([e,i])=>{e.split(",").forEach(n=>{t.textTracks&&t.textTracks.removeEventListener(n,i)}),i()}),this.propagateMediaState(r.MEDIA_PAUSED,!0)}propagateMediaState(t,e){u(this.mediaStateReceivers,t,e)}associateElement(t){if(!t)return;const{associatedElementSubscriptions:e}=this;if(e.has(t))return;const i=this.registerMediaStateReceiver.bind(this),s=this.unregisterMediaStateReceiver.bind(this),n=$(t,i,s);Object.keys(h).forEach(o=>{t.addEventListener(h[o],this[`_handle${v(o,!0)}`])}),e.set(t,n)}unassociateElement(t){if(!t)return;const{associatedElementSubscriptions:e}=this;if(!e.has(t))return;e.get(t)(),e.delete(t),Object.keys(h).forEach(s=>{t.removeEventListener(h[s],this[`_handle${v(s,!0)}`])})}registerMediaStateReceiver(t){if(!t)return;const e=this.mediaStateReceivers;e.indexOf(t)>-1||(e.push(t),this.media&&(u([t],r.MEDIA_CAPTIONS_LIST,l(this.captionTracks)||void 0),u([t],r.MEDIA_SUBTITLES_LIST,l(this.subtitleTracks)||void 0),u([t],r.MEDIA_CAPTIONS_SHOWING,l(this.showingCaptionTracks)||void 0),u([t],r.MEDIA_SUBTITLES_SHOWING,l(this.showingSubtitleTracks)||void 0),u([t],r.MEDIA_PAUSED,this.paused),u([t],r.MEDIA_MUTED,this.muted),u([t],r.MEDIA_VOLUME,this.volume),u([t],r.MEDIA_VOLUME_LEVEL,this.volumeLevel),u([t],r.MEDIA_CURRENT_TIME,this.currentTime),u([t],r.MEDIA_DURATION,this.duration),u([t],r.MEDIA_PLAYBACK_RATE,this.playbackRate)))}unregisterMediaStateReceiver(t){const e=this.mediaStateReceivers,i=e.indexOf(t);i<0||e.splice(i,1)}play(){this.dispatchEvent(new E.CustomEvent(y))}pause(){this.dispatchEvent(new E.CustomEvent(Q))}get paused(){return this.media?this.media.paused:!0}get muted(){return!!(this.media&&this.media.muted)}set muted(t){const e=t?x:N;this.dispatchEvent(new E.CustomEvent(e))}get volume(){const t=this.media;return t?t.volume:1}set volume(t){this.dispatchEvent(new E.CustomEvent(B,{detail:t}))}get volumeLevel(){let t="high";if(!this.media)return t;const{muted:e,volume:i}=this.media;return i===0||e?t="off":i<.5?t="low":i<.75&&(t="medium"),t}requestFullscreen(){this.dispatchEvent(new E.CustomEvent(W))}exitFullscreen(){this.dispatchEvent(new E.CustomEvent(H))}get currentTime(){const t=this.media;return t?t.currentTime:0}set currentTime(t){this.dispatchEvent(new E.CustomEvent(j,{detail:t}))}get duration(){const t=this.media;return t?t.duration:NaN}get playbackRate(){const t=this.media;return t?t.playbackRate:1}set playbackRate(t){this.dispatchEvent(new E.CustomEvent(K,{detail:t}))}get subtitleTracks(){return I(this.media,{kind:_.SUBTITLES})}get captionTracks(){return I(this.media,{kind:_.CAPTIONS})}get showingSubtitleTracks(){return I(this.media,{kind:_.SUBTITLES,mode:T.SHOWING})}get showingCaptionTracks(){return I(this.media,{kind:_.CAPTIONS,mode:T.SHOWING})}get isPip(){return this.media&&this.media==this.getRootNode().pictureInPictureElement}requestPictureInPicture(){this.dispatchEvent(new E.CustomEvent(G))}exitPictureInPicture(){this.dispatchEvent(new E.CustomEvent(V))}requestPreview(t){this.dispatchEvent(new E.CustomEvent(F,{detail:t}))}}const q=Object.values(r),P=a=>{var i,s,n;const{constructor:{observedAttributes:t}}=a,e=(n=(s=(i=a==null?void 0:a.getAttribute)==null?void 0:i.call(a,r.MEDIA_CHROME_ATTRIBUTES))==null?void 0:s.split)==null?void 0:n.call(s,/\s+/);return Array.isArray(t||e)?(t||e).filter(o=>q.includes(o)):[]},D=a=>!!P(a).length,Y=(a,t,e)=>e==null?a.removeAttribute(t):typeof e=="boolean"?e?a.setAttribute(t,""):a.removeAttribute(t):Number.isNaN(e)?a.removeAttribute(t):a.setAttribute(t,e),X=a=>{var t;return!!((t=a.closest)==null?void 0:t.call(a,'*[slot="media"]'))},A=(a,t)=>{if(X(a))return;const e=(s,n)=>{var m,d;D(s)&&n(s);const{children:o=[]}=s!=null?s:{},p=(d=(m=s==null?void 0:s.shadowRoot)==null?void 0:m.children)!=null?d:[];[...o,...p].forEach(f=>A(f,n))},i=a==null?void 0:a.nodeName.toLowerCase();if(i.includes("-")&&!D(a)){E.customElements.whenDefined(i).then(()=>{e(a,t)});return}e(a,t)},u=(a,t,e)=>{a.forEach(i=>{!P(i).includes(t)||Y(i,t,e)})},$=(a,t,e)=>{A(a,t);const i=c=>{var d;const m=(d=c==null?void 0:c.composedPath()[0])!=null?d:c.target;t(m)},s=c=>{var d;const m=(d=c==null?void 0:c.composedPath()[0])!=null?d:c.target;e(m)};a.addEventListener(h.REGISTER_MEDIA_STATE_RECEIVER,i),a.addEventListener(h.UNREGISTER_MEDIA_STATE_RECEIVER,s);const n=(c,m)=>{c.forEach(d=>{const{addedNodes:f=[],removedNodes:L=[],type:U,target:R,attributeName:k}=d;U==="childList"?(Array.prototype.forEach.call(f,g=>A(g,t)),Array.prototype.forEach.call(L,g=>A(g,e))):U==="attributes"&&k===r.MEDIA_CHROME_ATTRIBUTES&&(D(R)?t(R):e(R))})},o=new MutationObserver(n);return o.observe(a,{childList:!0,attributes:!0,subtree:!0}),()=>{A(a,e),o.disconnect(),a.removeEventListener(h.REGISTER_MEDIA_STATE_RECEIVER,i),a.removeEventListener(h.UNREGISTER_MEDIA_STATE_RECEIVER,s)}};O("media-controller",b);export default b;
