import k from"./media-container.js";import{defineCustomElement as O}from"./utils/defineCustomElement.js";import{Window as o,Document as w}from"./utils/server-safe-globals.js";import{fullscreenApi as T}from"./utils/fullscreenApi.js";import{constToCamel as g}from"./utils/stringUtils.js";import{MediaUIEvents as h,MediaUIAttributes as r,TextTrackKinds as p,TextTrackModes as _}from"./constants.js";import{stringifyTextTrackList as m,getTextTracksList as l,updateTracksModeTo as M}from"./utils/captions.js";const{MEDIA_PLAY_REQUEST:Q,MEDIA_PAUSE_REQUEST:y,MEDIA_MUTE_REQUEST:x,MEDIA_UNMUTE_REQUEST:N,MEDIA_VOLUME_REQUEST:B,MEDIA_ENTER_FULLSCREEN_REQUEST:H,MEDIA_EXIT_FULLSCREEN_REQUEST:W,MEDIA_SEEK_REQUEST:j,MEDIA_PREVIEW_REQUEST:G,MEDIA_ENTER_PIP_REQUEST:F,MEDIA_EXIT_PIP_REQUEST:V,MEDIA_PLAYBACK_RATE_REQUEST:K}=h;class b extends k{constructor(){super();this.mediaStateReceivers=[],this.associatedElementSubscriptions=new Map,this.associatedElements=[],this.associateElement(this);const e={MEDIA_PLAY_REQUEST:()=>this.media.play(),MEDIA_PAUSE_REQUEST:()=>this.media.pause(),MEDIA_MUTE_REQUEST:()=>this.media.muted=!0,MEDIA_UNMUTE_REQUEST:()=>{const t=this.media;t.muted=!1,t.volume===0&&(t.volume=.25)},MEDIA_VOLUME_REQUEST:t=>{const i=this.media,s=t.detail;i.volume=s,s>0&&i.muted&&(i.muted=!1);try{o.localStorage.setItem("media-chrome-pref-volume",s.toString())}catch(n){}},MEDIA_ENTER_FULLSCREEN_REQUEST:()=>{const t=this.getRootNode();t.pictureInPictureElement&&t.exitPictureInPicture(),super[T.enter]()},MEDIA_EXIT_FULLSCREEN_REQUEST:()=>{w[T.exit]()},MEDIA_ENTER_PIP_REQUEST:()=>{const t=this.getRootNode(),i=this.media;!t.pictureInPictureEnabled||(t[T.element]&&t[T.exit](),i.requestPictureInPicture())},MEDIA_EXIT_PIP_REQUEST:()=>{const t=this.getRootNode();t.exitPictureInPicture&&t.exitPictureInPicture()},MEDIA_SEEK_REQUEST:t=>{const i=this.media,s=t.detail;(i.readyState>0||i.readyState===void 0)&&(i.currentTime=s)},MEDIA_PLAYBACK_RATE_REQUEST:t=>{this.media.playbackRate=t.detail},MEDIA_PREVIEW_REQUEST:t=>{const i=this.media;if(!i)return;const[s]=l(i,{kind:p.METADATA,label:"thumbnails"});if(!(s&&s.cues))return;const n=t.detail,E=Array.prototype.find.call(s.cues,S=>S.startTime>=n);if(!E)return;const I=new URL(E.text),c=new URLSearchParams(I.hash).get("#xywh");this.propagateMediaState(r.MEDIA_PREVIEW_IMAGE,I.href),this.propagateMediaState(r.MEDIA_PREVIEW_COORDS,c.split(",").join(" "))},MEDIA_SHOW_CAPTIONS_REQUEST:t=>{const i=this.captionTracks,{detail:s=[]}=t;M(_.SHOWING,i,s)},MEDIA_DISABLE_CAPTIONS_REQUEST:t=>{const i=this.captionTracks,{detail:s=[]}=t;M(_.DISABLED,i,s)},MEDIA_SHOW_SUBTITLES_REQUEST:t=>{const i=this.subtitleTracks,{detail:s=[]}=t;M(_.SHOWING,i,s)},MEDIA_DISABLE_SUBTITLES_REQUEST:t=>{const i=this.subtitleTracks,{detail:s=[]}=t;M(_.DISABLED,i,s)}};Object.keys(e).forEach(t=>{const i=`_handle${g(t,!0)}`;this[i]=s=>{if(s.stopPropagation(),!this.media){console.warn("MediaController: No media available.");return}e[t](s,this.media)},this.addEventListener(h[t],this[i])}),this._mediaStatePropagators={"play,pause":()=>{this.propagateMediaState(r.MEDIA_PAUSED,this.media.paused)},volumechange:()=>{const{muted:t,volume:i}=this.media;let s="high";i==0||t?s="off":i<.5?s="low":i<.75&&(s="medium"),this.propagateMediaState(r.MEDIA_MUTED,t),this.propagateMediaState(r.MEDIA_VOLUME,i),this.propagateMediaState(r.MEDIA_VOLUME_LEVEL,s)},[T.event]:()=>{const t=this.getRootNode()[T.element];this.propagateMediaState(r.MEDIA_IS_FULLSCREEN,t===this)},"enterpictureinpicture,leavepictureinpicture":t=>{let i;t?i=t.type=="enterpictureinpicture":i=this.media==this.getRootNode().pictureInPictureElement,this.propagateMediaState(r.MEDIA_IS_PIP,i)},"timeupdate,loadedmetadata":()=>{this.propagateMediaState(r.MEDIA_CURRENT_TIME,this.media.currentTime)},"durationchange,loadedmetadata":()=>{this.propagateMediaState(r.MEDIA_DURATION,this.media.duration)},ratechange:()=>{this.propagateMediaState(r.MEDIA_PLAYBACK_RATE,this.media.playbackRate)}},this._textTrackMediaStatePropagators={"addtrack,removetrack":()=>{this.propagateMediaState(r.MEDIA_CAPTIONS_LIST,m(this.captionTracks)||void 0),this.propagateMediaState(r.MEDIA_SUBTITLES_LIST,m(this.subtitleTracks)||void 0),this.propagateMediaState(r.MEDIA_CAPTIONS_SHOWING,m(this.showingCaptionTracks)||void 0),this.propagateMediaState(r.MEDIA_SUBTITLES_SHOWING,m(this.showingSubtitleTracks)||void 0)},change:()=>{this.propagateMediaState(r.MEDIA_CAPTIONS_SHOWING,m(this.showingCaptionTracks)||void 0),this.propagateMediaState(r.MEDIA_SUBTITLES_SHOWING,m(this.showingSubtitleTracks)||void 0)}}}mediaSetCallback(e){if(!!super.mediaSetCallback(e)){Object.keys(this._mediaStatePropagators).forEach(t=>{const i=t.split(","),s=this._mediaStatePropagators[t];i.forEach(n=>{(n==T.event?this.getRootNode():e).addEventListener(n,s)}),s()}),Object.entries(this._textTrackMediaStatePropagators).forEach(([t,i])=>{t.split(",").forEach(n=>{e.textTracks.addEventListener(n,i)}),i()});try{const t=o.localStorage.getItem("media-chrome-pref-volume");t!==null&&(e.volume=t)}catch(t){console.debug("Error getting volume pref",t)}}}mediaUnsetCallback(e){super.mediaUnsetCallback(e),Object.keys(this._mediaStatePropagators).forEach(t=>{const{events:i,handler:s}=this.mediaStatePropagators[t];i.forEach(n=>{(n==T.event?this.getRootNode():e).removeEventListener(n,s)})}),Object.entries(this._textTrackMediaStatePropagators).forEach(([t,i])=>{t.split(",").forEach(n=>{e.textTracks.removeEventListener(n,i)}),i()}),this.propagateMediaState(r.MEDIA_PAUSED,!0)}propagateMediaState(e,t){d(this.mediaStateReceivers,e,t)}associateElement(e){if(!e)return;const{associatedElementSubscriptions:t}=this;if(t.has(e))return;const i=this.registerMediaStateReceiver.bind(this),s=this.unregisterMediaStateReceiver.bind(this),n=$(e,i,s);Object.keys(h).forEach(E=>{e.addEventListener(h[E],this[`_handle${g(E,!0)}`])}),t.set(e,n)}unassociateElement(e){if(!e)return;const{associatedElementSubscriptions:t}=this;if(!t.has(e))return;t.get(e)(),t.delete(e),Object.keys(h).forEach(s=>{e.removeEventListener(h[s],this[`_handle${g(s,!0)}`])})}registerMediaStateReceiver(e){if(!e)return;const t=this.mediaStateReceivers;t.indexOf(e)>-1||(t.push(e),this.media&&(d([e],r.MEDIA_CAPTIONS_LIST,m(this.captionTracks)||void 0),d([e],r.MEDIA_SUBTITLES_LIST,m(this.subtitleTracks)||void 0),d([e],r.MEDIA_CAPTIONS_SHOWING,m(this.showingCaptionTracks)||void 0),d([e],r.MEDIA_SUBTITLES_SHOWING,m(this.showingSubtitleTracks)||void 0),d([e],r.MEDIA_PAUSED,this.media.paused),d([e],r.MEDIA_MUTED,this.media.muted),d([e],r.MEDIA_VOLUME,this.media.volume),d([e],r.MEDIA_CURRENT_TIME,this.media.currentTime),d([e],r.MEDIA_DURATION,this.media.duration),d([e],r.MEDIA_PLAYBACK_RATE,this.media.playbackRate)))}unregisterMediaStateReceiver(e){const t=this.mediaStateReceivers,i=t.indexOf(e);i<0||t.splice(i,1)}play(){this.dispatchEvent(new o.CustomEvent(Q))}pause(){this.dispatchEvent(new o.CustomEvent(y))}get muted(){return!!(this.media&&this.media.muted)}set muted(e){const t=e?x:N;this.dispatchEvent(new o.CustomEvent(t))}get volume(){const e=this.media;return e?e.volume:1}set volume(e){this.dispatchEvent(new o.CustomEvent(B,{detail:e}))}requestFullscreen(){this.dispatchEvent(new o.CustomEvent(H))}exitFullscreen(){this.dispatchEvent(new o.CustomEvent(W))}get currentTime(){const e=this.media;return e?e.currentTime:0}set currentTime(e){this.dispatchEvent(new o.CustomEvent(j,{detail:e}))}get playbackRate(){const e=this.media;return e?e.playbackRate:1}set playbackRate(e){this.dispatchEvent(new o.CustomEvent(K,{detail:e}))}get subtitleTracks(){return l(this.media,{kind:p.SUBTITLES})}get captionTracks(){return l(this.media,{kind:p.CAPTIONS})}get showingSubtitleTracks(){return l(this.media,{kind:p.SUBTITLES,mode:_.SHOWING})}get showingCaptionTracks(){return l(this.media,{kind:p.CAPTIONS,mode:_.SHOWING})}requestPictureInPicture(){this.dispatchEvent(new o.CustomEvent(F))}exitPictureInPicture(){this.dispatchEvent(new o.CustomEvent(V))}requestPreview(e){this.dispatchEvent(new o.CustomEvent(G,{detail:e}))}}const Y=Object.values(r),P=a=>{var i,s,n;const{constructor:{observedAttributes:e}}=a,t=(n=(s=(i=a==null?void 0:a.getAttribute)==null?void 0:i.call(a,r.MEDIA_CHROME_ATTRIBUTES))==null?void 0:s.split)==null?void 0:n.call(s,/\s+/);return Array.isArray(e||t)?(e||t).filter(E=>Y.includes(E)):[]},v=a=>!!P(a).length,q=(a,e,t)=>t==null?a.removeAttribute(e):typeof t=="boolean"?t?a.setAttribute(e,""):a.removeAttribute(e):Number.isNaN(t)?a.removeAttribute(e):a.setAttribute(e,t),X=a=>{var e;return!!((e=a.closest)==null?void 0:e.call(a,'*[slot="media"]'))},A=(a,e)=>{if(X(a))return;const t=(s,n)=>{var S,u;v(s)&&n(s);const{children:E=[]}=s!=null?s:{},I=(u=(S=s==null?void 0:s.shadowRoot)==null?void 0:S.children)!=null?u:[];[...E,...I].forEach(R=>A(R,n))},i=a==null?void 0:a.nodeName.toLowerCase();if(i.includes("-")&&!v(a)){o.customElements.whenDefined(i).then(()=>{t(a,e)});return}t(a,e)},d=(a,e,t)=>{a.forEach(i=>{!P(i).includes(e)||q(i,e,t)})},$=(a,e,t)=>{A(a,e);const i=c=>{var u;const S=(u=c==null?void 0:c.composedPath()[0])!=null?u:c.target;e(S)},s=c=>{var u;const S=(u=c==null?void 0:c.composedPath()[0])!=null?u:c.target;t(S)};a.addEventListener(h.REGISTER_MEDIA_STATE_RECEIVER,i),a.addEventListener(h.UNREGISTER_MEDIA_STATE_RECEIVER,s);const n=(c,S)=>{c.forEach(u=>{const{addedNodes:R=[],removedNodes:L=[],type:D,target:f,attributeName:C}=u;D==="childList"?(Array.prototype.forEach.call(R,U=>A(U,e)),Array.prototype.forEach.call(L,U=>A(U,t))):D==="attributes"&&C===r.MEDIA_CHROME_ATTRIBUTES&&(v(f)?e(f):t(f))})},E=new MutationObserver(n);return E.observe(a,{childList:!0,attributes:!0,subtree:!0}),()=>{A(a,t),E.disconnect(),a.removeEventListener(h.REGISTER_MEDIA_STATE_RECEIVER,i),a.removeEventListener(h.UNREGISTER_MEDIA_STATE_RECEIVER,s)}};O("media-controller",b);export default b;
